### REPLACE THIS FILE WITH your own Dockerfile.alpine.df from DF Portal

# export APP_IMAGE=alpine-distro-3.9-or-greater:myapp
# docker build -t ${APP_IMAGE}-df -f Dockerfile.alpine.df
#   --build-arg "APP_IMAGE=${APP_IMAGE}" --build-arg "DF_APP_NAME=${DF_APP_NAME}" --build-arg "DF_COMPONENT=${DF_COMPONENT}"  .

ARG APP_IMAGE

FROM alpine:3.11.5 as df-runtime


RUN cd /etc/apk/keys && wget https://repo.deepfactor.io/repo/alpine/keys/dfbuild@deepfactor.io-5f35ef3a.rsa.pub
RUN echo "https://repo.deepfactor.io/repo/alpine" >> /etc/apk/repositories
RUN apk add deepfactor-runtime=1.1-r503

ARG APP_IMAGE
ARG DF_APP_NAME
ARG DF_COMPONENT
ENV DF_API_TOKEN=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyaWQiOiIwMDAwMDAwMC0wMDAwLTAwMDAtMDAwMC0wMDAwMDAwMDAwMDAiLCJ0b2tlbmlkIjoiZDQxYTM5ZWEtZThmZi00ZGNiLWE2ZmQtZjUwN2FkZjQ2ZDBjIiwic3ViZG9tYWluIjoiZGYiLCJjdXN0b21lcmlkIjoiNjgwNDBmYzUtZjUxMS00NGFmLTllNjUtYjUxMDY5OTFjNjg1IiwidXNlcmxldmVsIjoiQ1VTVE9NRVIiLCJyb2xlaWQiOiJlOWFiNzdmMi1kMjUyLTQ5YmUtOWRlNy03MWFkYTE4ODczYjYiLCJyb2xlbmFtZSI6IkNfQURNSU4iLCJ0b2tlbl90eXBlIjoiREZfQVBJX1RPS0VOIiwiZXhwIjoxNjM1ODE2Mjk0LCJpYXQiOjE2MDQyODAyOTQsIm5iZiI6MTYwNDI4MDI5NCwicG9ydGFsVVJMIjoiZGVtby5kZi5pbmFkZW1vLmNvbSIsImN1c3RvbWVyUG9ydGFsVVJMIjoiZGYuZGVtby5kZi5pbmFkZW1vLmNvbSIsInBvcnRhbENBIjoiTUlJRndEQ0NBNmlnQXdJQkFnSVVSbm1Za3F4L2Z1ZE8vNjhERFNTYzl3VVRBSW93RFFZSktvWklodmNOQVFFTFxuQlFBd2FURUxNQWtHQTFVRUJoTUNWVk14RXpBUkJnTlZCQWdNQ2tOaGJHbG1iM0p1YVdFeEVUQVBCZ05WQkFjTVxuQ0ZOaGJpQktiM05sTVJNd0VRWURWUVFLREFwRVpXVndSbUZqZEc5eU1SMHdHd1lEVlFRRERCUkVaV1Z3Um1GalxuZEc5eUlGQnZjblJoYkNCRFFUQWVGdzB5TURFd01qRXhPVE14TkRoYUZ3MHpNREV3TVRreE9UTXhORGhhTUdreFxuQ3pBSkJnTlZCQVlUQWxWVE1STXdFUVlEVlFRSURBcERZV3hwWm05eWJtbGhNUkV3RHdZRFZRUUhEQWhUWVc0Z1xuU205elpURVRNQkVHQTFVRUNnd0tSR1ZsY0VaaFkzUnZjakVkTUJzR0ExVUVBd3dVUkdWbGNFWmhZM1J2Y2lCUVxuYjNKMFlXd2dRMEV3Z2dJaU1BMEdDU3FHU0liM0RRRUJBUVVBQTRJQ0R3QXdnZ0lLQW9JQ0FRQzJ3TENxMy82SFxudHQrVmhRZlh2d1QwZVloN1UwQzMrZmZzTEcxeDRQNWtYc3dlMzRrY3A5RWlicmtzU3lUZmlTOXBrSFA2YXJxUFxubTdGS3BxdnpkaXM4NW1USHBxZkJKOTFEcXljUzZ5TkxGZFdGS2dBdGlMNkNRSzNMNDlhZnl3V2U0Vm5NVkRsM1xuQU90Z3RFdm04bWNSK0xQQUgwSjFrK2xVTjRUcFNBNWQ5Sk4rUG8vNkxGSzZkYURmNUYzdEFFMWpSTy9zN0czTlxuRWpSeUVSU2ordjk1bW14RkdqTkFIVktWQkZBY3hQbW1jUUdXbkNOMFNxelAvbFpBRXVveWV3NVI3RUFPL1pnelxuQkxGZ0lRZi8rVlBnb0hXSGZBS3RTNm12cFNJck1sSzJKaS9FRUJDc240eTNucHF1OUNRRWNHSTNGeDByMnI1aVxub2tXV1kwSlBTcFIyNTNJT2dCemFjTEtWenZ3MmhzRjUxYzMwUDJxTUl3K1BuaXNTMXNuM2FEQlZLdzRENElPV1xuQ3RmeWhuT3cyK0hid3l2dmpqOVlYN05nU0t0enl0aUtFQ1YwNkhDZGxJZFZYT3luL2ltam5yUWY3S1JNZlVOb1xucS9pM1hLc25sckFtdTZQVGh4REJGUlUzNTNKb1B1ZUFHRFhRQmY1TUx5S2FoTGpJUm8rbVd2MnI1SWl5eWZMR1xuNUpSYlE2dmNiZ3BxMjNZdjZjSWZxdmlwZkZLTTY2WmlEeTluTm9yYTB3Si9zTVh0bnJveGVCWFh3Z2J1eGlNalxuUXg2OFlRam1BcTJaeEtCMGxuc3Z4M2dxUDJkMTNXRkE2VVhJbDdQQnMvM1M0ZFowZUxFdTNRb0V3Yll5L3BTaVxuRDJXa2hnM3AvK2RZWjlXWURTQmlaajM5L2I1Z1UwQ2R5d0lEQVFBQm8yQXdYakFkQmdOVkhRNEVGZ1FVRkk5NVxuVU9tTGw0ME5SdW0xWnY2MVk2QTRlMm93SHdZRFZSMGpCQmd3Rm9BVUZJOTVVT21MbDQwTlJ1bTFadjYxWTZBNFxuZTJvd0R3WURWUjBUQVFIL0JBVXdBd0VCL3pBTEJnTlZIUThFQkFNQ0FRWXdEUVlKS29aSWh2Y05BUUVMQlFBRFxuZ2dJQkFCU3VScnVBSG9xbUc2bVlNNXg5N0JQa0RtLzZhUW5hMUZsUmFtSXFpZ0VpdzJNSCtuWGgrQ2NyN1JrZlxuSTl2RjNwQ0JpNm1DRmExSE1hOUlVNTJXMktUaC9KREcyeTFPVm9VSDdPOTl6UWovSGlKaXh0cXhCQmRYY0ZTRFxuaURiL2xqSGNubXloei9uS3pwMkVZMlMzWDUxWjFnQXRjSDFwWnB6eGNITkh5cVN6c1ZrNnJnQ2V3NmVWWm4wR1xuYUp5TFpmNTBIeSswa1dxUXpvZzdWVGNXSFFEOEFJb0NVYzBSZk95aXV1bWEvbmx6dEFnYldkbmlkeDN5RVdUd1xuNGRtdExWNEZPRzBpRk9LRWFBWW5UNUhrZGxBZkRaaUt3YU5OVFFQRU9OZ1pDekc5M0w0YjUvbWhTTDZicGNnelxuVDRLYklEditrZk96cGczQjNkZzh5QnhZSCsvUnB2WEpBTnNyL3YrYlppd3JDZmtseG9hb2tmMVJkR1lpS2VjaVxuNWhBRzVqV3VSMThNZmVmY2tKbGVXS09tYjBhUjhNS3hFTXovNk1XWVRCYTlCZ0VOQ29EMHQ5QUZxd0Q4c1NsS1xueWs2V2RaUDlqUHZBdGdWZUdHUE03ei85YmxIbktUSWV3RFd5L2oyTGhPMTFpbFZPL3dVVXBSNWVOYWoxQ04zd1xuTkRscVVoSGVaYkJNS01Fb2R1ZWh6VVFHTCtKYURVZzBPTXhubS8xSSs3L0paSWFoMnVZLzBSV2NvSjBtcm5DMVxuRnNlMC9TandSY1JVUU9Nd0lVSHorRFM1OWxVdEkwMktMYWljbUYraTAvZXpqWmkweFQrbUI3bVRPbkxoRlZMOVxuMGx5UUxYZ3Jta09USmZRRm9hbGtOTkRHdXlsNmp0S1hKWkZXUDBsc1NqZWxZZSswIn0.ZsbrKFCkiPZUaQ87km0NajNkJqHA36aK0ANRb9Ym4Fo

# option: pass via build ARG or set here
ENV DF_APP "${DF_APP_NAME}"
ENV DF_COMPONENT "${DF_COMPONENT}"

# If necessary, add --add-host=my-df-portal:10.0.0.1 to your image build AND run commands for DF portal DNS:
RUN dfctl register -a "$DF_APP" -c "$DF_COMPONENT" -o /usr/lib/libdf.so -v
# option: dfctl register/create individual components in container

# Warning: The above df-runtime container's built libdf.so install must match
#  the version of the target container's libc.so.
#  i.e. APP_IMAGE must contain a musl libc
FROM ${APP_IMAGE}
COPY --from=df-runtime /usr/lib/libdf.so /usr/lib/libdf.so
# Add runtime dependencies
RUN IMG_USER=`id -un`
USER root
RUN apk add libstdc++ libexecinfo
USER ${IMG_USER}


# The following is an optional smoke test for redhat and debian distro types.
RUN env LD_PRELOAD=/usr/lib/libdf.so sh -c 'apk list > /dev/null' || \
    (echo -e "\n\n\nError, DeepFactor dependency not met.\n\n\n/tmp/deepfactor.log:\n" \
    && cat /tmp/deepfactor.log && false)

# option: set LD_PRELOAD in app startup cmd or script
ENV LD_PRELOAD=/usr/lib/libdf.so
